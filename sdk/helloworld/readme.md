# CloudPSS 潮流结果数据结构（开发笔记）

本文面向 `runner.result.getBuses()` 与 `runner.result.getBranches()` 的**返回值结构**，提供字段语义、变量类型、单位与一致性校验要点，便于在程序中稳定解析与二次处理。示例代码已去除，仅保留结构与解释。

---

## 1) 顶层结构

* **类型**：`list`
* **含义**：结果表列表。当前通常仅含**一个**表（例如 `Buses` 或 `Branches`），保留为将来扩展多表的可能。
* **元素**：每个元素为**表对象**（`dict`）。

---

## 2) 表对象（list 内的 dict）

* **`type`**

  * 类型：`str`
  * 典型值：`"table"`
  * 含义：表格对象标识。

* **`key`**

  * 类型：`str`
  * 例：`"buses-table"`、`"branches-table"`
  * 含义：表对象的内部键名，用于区分不同表。

* **`version`**

  * 类型：`int`
  * 含义：数据格式版本号，便于前后兼容。

* **`data`**

  * 类型：`dict`
  * 含义：表主体，包含标题与列数据（**核心**，见下）。

---

## 3) `data`（表主体）

* **`title`**

  * 类型：`str`
  * 例：`"Buses"`、`"Branches"`
  * 含义：表标题（人类可读名称）。

* **`columns`**

  * 类型：`list[dict]`
  * 含义：**按列存储**的数据集合。每个元素是一个“列对象”，所有列的 `data` 列表使用**相同的行索引**对齐，体现“第 i 行”的业务含义。

---

## 4) 列对象（`columns` 内的 dict）

* **`name`**

  * 类型：`str`
  * 含义：列名。为兼顾前端排版，可能包含 HTML 标签（如 `<i>V</i><sub>m</sub> / pu` 表示 “Vm/pu”）。

* **`type`**

  * 类型：`str`
  * 典型值：`"html"` / `"number"`
  * 含义：列的数据类型提示：

    * `"html"`：单元格内容为字符串（常用于 **Key/标签** 等，如 `canvas_0_1093`）。
    * `"number"`：单元格内容为数值（Python 侧通常解析为 `float` 或 `int`）。

* **`data`**

  * 类型：`list`
  * 含义：该列的**整列数据**，长度 = 表的行数。第 `i` 个元素与其它列的第 `i` 个元素共同构成**第 i 行**。

> **行对齐规则**：对任意列 `Ck`，`Ck["data"][i]` 与所有列的 `["data"][i]` **同属一行**。
> **健壮性建议**：默认假设各列 `data` 等长；如需防御性编程，应在处理前校验列长一致性。

---

## 5) `getBuses()` —— 节点电压表（字段字典）

> 表示**每个母线节点**在潮流稳态下的电压与注入功率信息。常见列如下（不同算例可能略有差异，实际以返回列为准）：

| 列名（可能含 HTML）                      | 业务含义           | 变量类型    | 单位/取值  | 备注                                          |
| --------------------------------- | -------------- | ------- | ------ | ------------------------------------------- |
| `Bus`                             | 节点 Key（内部唯一标识） | `str`   | —      | 形如 `canvas_0_1054`，可与 Web 端 `cell=...` 对应定位 |
| `Node`                            | 内部节点 Key       | `str`   | —      | 有时为空，依算例而定                                  |
| `<i>V</i><sub>m</sub> / pu`       | 电压幅值           | `float` | `pu`   | 标幺值                                         |
| `<i>V</i><sub>a</sub> / deg`      | 电压相角           | `float` | `deg`  | 角度（度）                                       |
| `<i>P</i><sub>gen</sub> / MW`     | 发电有功           | `float` | `MW`   | 该节点发电注入 P                                   |
| `<i>Q</i><sub>gen</sub> / MVar`   | 发电无功           | `float` | `MVar` | 该节点发电注入 Q                                   |
| `<i>P</i><sub>load</sub> / MW`    | 负荷有功           | `float` | `MW`   | 该节点负荷吸收 P                                   |
| `<i>Q</i><sub>load</sub> / MVar`  | 负荷无功           | `float` | `MVar` | 该节点负荷吸收 Q                                   |
| `<i>P</i><sub>shunt</sub> / MW`   | 并联支路等效有功       | `float` | `MW`   | 并补/并联元件等效注入                                 |
| `<i>Q</i><sub>shunt</sub> / MVar` | 并联支路等效无功       | `float` | `MVar` | 并补/并联元件等效注入                                 |
| `<i>P</i><sub>res</sub> / MW`     | 有功残差           | `float` | `MW`   | 潮流平衡残差，**接近 0 为正常**                         |
| `<i>Q</i><sub>res</sub> / MVar`   | 无功残差           | `float` | `MVar` | 潮流平衡残差，**接近 0 为正常**                         |

**使用提示与校验：**

* `Vm`、`Va` 直接用于电压越限/角差分析。
* `Pgen/Qgen` 与 `Pload/Qload` 可用于节点注入功率统计与功率平衡核对。
* `Pres/Qres` 为数值求解残差，通常应数量级很小（接近 0）；异常偏大时需检查模型或收敛性。

---

## 6) `getBranches()` —— 支路功率表（字段字典）

> 表示\*\*每条支路（线路/变压器等）\*\*的双向潮流与损耗信息。常见列如下：

| 列名（可能含 HTML）                     | 业务含义           | 变量类型    | 单位/取值  | 备注                            |
| -------------------------------- | -------------- | ------- | ------ | ----------------------------- |
| `Branch`                         | 支路 Key（内部唯一标识） | `str`   | —      | 形如 `canvas_0_1065`，可与 Web 端定位 |
| `From bus`                       | 起始母线 Key       | `str`   | —      | 与 `To bus` 一起确定线路两端           |
| `To bus`                         | 终止母线 Key       | `str`   | —      | —                             |
| `<i>P</i><sub>ij</sub> / MW`     | **i→j** 方向有功   | `float` | `MW`   | 从起点流向终点的 P                    |
| `<i>Q</i><sub>ij</sub> / MVar`   | **i→j** 方向无功   | `float` | `MVar` | 从起点流向终点的 Q                    |
| `<i>P</i><sub>ji</sub> / MW`     | **j→i** 方向有功   | `float` | `MW`   | 反向 P                          |
| `<i>Q</i><sub>ji</sub> / MVar`   | **j→i** 方向无功   | `float` | `MVar` | 反向 Q                          |
| `<i>P</i><sub>loss</sub> / MW`   | 有功损耗           | `float` | `MW`   | 线路/变压器损耗 P                    |
| `<i>Q</i><sub>loss</sub> / MVar` | 无功损耗           | `float` | `MVar` | 线路/变压器损耗 Q                    |

**功率守恒一致性（逐行校验）：**

* 有功：`Ploss ≈ Pij + Pji`
* 无功：`Qloss ≈ Qij + Qji`
  若偏差较大，建议检查参数、基准、方向约定或收敛状态。

---

## 7) Key 与 Web 端 GUI 的对应关系

* **Bus / Branch / Node** 中出现的 `canvas_0_xxxx` 属于**内部唯一 Key**。
* 在 Web 端 SimStudio 中选中元件后，浏览器地址栏常带有 `cell=canvas_0_xxxx`；也可在“元件信息”面板查看相同 Key。
* **用途**：将后端结果与前端图元**一一对应**，支持定位与联动。

---

## 8) 解析与适配建议（工程实践）

1. **列名兼容**

   * 列名含 HTML（上/下标、斜体），解析时**不要删除/替换**列名中的标签，否则无法准确匹配列。
   * 建议在代码中维护“**列名别名映射**”（如把 `<i>V</i><sub>m</sub> / pu` 映射为 `Vm_pu` 供内部使用），但底层匹配仍以**原始列名**为准。

2. **类型处理**

   * `"number"` 列可按 `float` 解析；`"html"` 列为 `str`。
   * 少数情况下可能出现空字符串 `""` 或 `None`，需容错。

3. **长度校验**

   * 处理前建议校验所有列的 `data` 长度一致。
   * 若不一致，优先排查数据来源或采取“就短不就长”的截断策略并打警告。

4. **单位与基准**

   * `pu`、`MW`、`MVar` 等单位按列名约定。
   * 不同算例的基准功率/电压可能不同，跨算例对比前请确保基准一致或先做归一化。

5. **质量控制**

   * `getBuses()` 中的 `Pres/Qres`、`getBranches()` 中的守恒校验可作为**快速健康检查**。
   * 对数值稳定性敏感的流程，建议记录并设定阈值（如 `abs(Pres) < 1e-4`）。

---

## 9) 与电磁暂态结果的区别（便于心智模型统一）

* `getBuses()` / `getBranches()`：**潮流稳态**的“**表**”结构（单断面快照，按列存储）。
* `getPlots()`（EMT）：**暂态时序**的“**波形**”结构（多个通道的时间序列）。
  两者数据形态不同：前者适合做表格统计/拓扑对齐，后者适合画曲线/时域分析。

---

以上即为 CloudPSS 潮流结果的结构化说明。按照本笔记对字段名、类型和含义的约定进行解析，可在无需查阅示例代码的前提下，稳定地完成与 GUI 的对齐、与数据库/报表的对接，以及跨算例的通用化处理。
